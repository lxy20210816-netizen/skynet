# 批量房产信息抓取脚本使用说明

## 概述

`batch_scrape.sh` 是一个用于批量抓取多个地区房产信息的Shell脚本，支持抓取二手公寓和一户建信息，并自动上传到Google Sheets。

## 功能特点

- 🏘️ **多地区支持**: 支持錦糸町、平井、亀戸、高島平、板橋区役所前、秋葉原、渋谷、上野、浅草寺等9个地区
- 🏢 **双类型抓取**: 同时抓取二手公寓和一户建信息
- 📊 **自动上传**: 抓取完成后自动上传到Google Sheets
- 🔄 **智能去重**: 自动检测重复房源，避免重复添加
- 📝 **详细日志**: 记录每个地区的抓取过程和结果
- ⚡ **批量处理**: 一次性处理多个地区，节省时间

## 使用方法

### 基本用法

```bash
# 抓取所有配置的地区（二手公寓+一户建）
./batch_scrape.sh

# 抓取指定地区
./batch_scrape.sh -s "錦糸町,亀戸,秋葉原"

# 只抓取二手公寓
./batch_scrape.sh -a

# 只抓取一户建
./batch_scrape.sh --house-only

# 试运行模式（不实际上传）
./batch_scrape.sh -d
```

### 命令行参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `-h, --help` | 显示帮助信息 | `./batch_scrape.sh -h` |
| `-s, --stations` | 指定要抓取的地区（逗号分隔） | `-s "錦糸町,亀戸"` |
| `-a, --apartment-only` | 只抓取二手公寓 | `./batch_scrape.sh -a` |
| `--house-only` | 只抓取一户建 | `./batch_scrape.sh --house-only` |
| `-d, --dry-run` | 试运行模式（不实际上传） | `./batch_scrape.sh -d` |
| `-v, --verbose` | 详细输出 | `./batch_scrape.sh -v` |

## 配置的地区

| 地区名称 | 所属区域 | 区域代码 |
|----------|----------|----------|
| 錦糸町 | 墨田区 | 13107 |
| 平井 | 墨田区 | 13107 |
| 亀戸 | 江东区 | 13108 |
| 高島平 | 板桥区 | 13119 |
| 板橋区役所前 | 板桥区 | 13119 |
| 秋葉原 | 千代田区 | 13101 |
| 渋谷 | 世田谷区 | 13112 |
| 上野 | 千代田区 | 13101 |
| 浅草寺 | 墨田区 | 13107 |

## 输出文件

### 数据文件
- 位置: `output/`
- 格式: `suumo_{地区}_{类型}_{时间戳}.json`
- 示例: `suumo_錦糸町_apartment_20251025_143022.json`

### 日志文件
- 位置: `logs/`
- 格式: `suumo_{地区}_{类型}_{时间戳}.log`
- 示例: `suumo_錦糸町_apartment_20251025_143022.log`

## 使用示例

### 1. 抓取所有地区
```bash
cd /Users/a0000/Desktop/workspace/skynet/scripts/scrapers/real_estate/suumo
./batch_scrape.sh
```

### 2. 抓取特定地区
```bash
# 只抓取錦糸町和亀戸
./batch_scrape.sh -s "錦糸町,亀戸"

# 只抓取东京核心区域
./batch_scrape.sh -s "秋葉原,渋谷,上野"
```

### 3. 只抓取特定类型
```bash
# 只抓取二手公寓
./batch_scrape.sh -a

# 只抓取一户建
./batch_scrape.sh --house-only
```

### 4. 试运行
```bash
# 查看将要抓取的地区，不实际上传
./batch_scrape.sh -d
```

## 执行流程

1. **环境检查**: 检查Python环境和必要依赖
2. **脚本验证**: 验证suumo_scraper.py脚本存在且可执行
3. **地区处理**: 按顺序处理每个配置的地区
4. **数据抓取**: 对每个地区抓取二手公寓和一户建信息
5. **自动上传**: 将抓取的数据上传到Google Sheets
6. **结果统计**: 显示抓取结果和统计信息

## 注意事项

### 时间控制
- 每个地区之间等待30秒，避免请求过于频繁
- 公寓和一户建抓取之间等待5秒
- 总执行时间约15-20分钟（9个地区）

### 错误处理
- 单个地区失败不会影响其他地区
- 详细的错误日志保存在logs目录
- 支持重试失败的地区

### 数据去重
- 自动检测重复房源URL
- 避免在Google Sheets中重复添加
- 支持追加模式，保留历史数据

## 故障排除

### 常见问题

1. **Python环境问题**
   ```bash
   # 检查Python版本
   python3 --version
   
   # 安装必要依赖
   pip install selenium gspread google-auth
   ```

2. **权限问题**
   ```bash
   # 添加执行权限
   chmod +x batch_scrape.sh
   chmod +x suumo_scraper.py
   ```

3. **网络问题**
   - 检查网络连接
   - 确保可以访问suumo.jp
   - 检查Google Sheets API权限

4. **查看详细日志**
   ```bash
   # 查看特定地区的抓取日志
   tail -f logs/suumo_錦糸町_apartment_*.log
   ```

## 高级用法

### 自定义配置
可以修改脚本中的地区配置：

```bash
# 编辑脚本，修改STATIONS数组
declare -A STATIONS=(
    ["新地区"]="区域代码"
    # ... 其他地区
)
```

### 定时执行
```bash
# 添加到crontab，每天上午9点执行
0 9 * * * /path/to/batch_scrape.sh
```

### 邮件通知
可以在脚本中添加邮件通知功能，抓取完成后发送结果邮件。

## 输出示例

```
[INFO] 2025-10-25 14:30:22 - 开始批量抓取房产信息...
[INFO] 2025-10-25 14:30:22 - 目标地区: 錦糸町 平井 亀戸 高島平 板橋区役所前 秋葉原 渋谷 上野 浅草寺
[SUCCESS] 2025-10-25 14:30:25 - Python环境检查通过
[SUCCESS] 2025-10-25 14:30:25 - 脚本检查通过
[INFO] 2025-10-25 14:30:25 - 开始抓取 錦糸町 (墨田区) 的房产信息...
[SUCCESS] 2025-10-25 14:31:15 - 錦糸町 二手公寓抓取成功
[SUCCESS] 2025-10-25 14:31:45 - 錦糸町 一户建抓取成功
...
[INFO] 2025-10-25 14:45:30 - === 抓取完成 ===
[INFO] 2025-10-25 14:45:30 - 总地区数: 9
[SUCCESS] 2025-10-25 14:45:30 - 成功: 9
[INFO] 2025-10-25 14:45:30 - 总耗时: 15分8秒
```

## 技术支持

如有问题，请检查：
1. 日志文件中的详细错误信息
2. Python环境和依赖包
3. 网络连接和API权限
4. Google Sheets配置
